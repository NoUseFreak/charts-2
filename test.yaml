job:
  snapshots:
    enabled: true
    # image:
    #   repository: mesosphere/aws-cli
    #   # tag: 1.14.5
    #   pullPolicy: IfNotPresent
    annotations:
      "helm.sh/hook": "pre-install"
    restartPolicy: Never
    pod:
      commands:
        - "/restore-from-snapshots.sh"

persistence:
  enabled: true
  snapshots:
    - id: "some-id1"
      size: 1Gi
    - id: "some-id2"
      size: 2Gi

configMaps:
  aws:
    enabled: true
    annotations:
      "helm.sh/hook": "pre-install"
    env:
      REGION: us-west-2
      CLUSTER_NAME: test.k8s.local
    files:
      restore-from-snapshots.sh: |
        {{- range $index, $snapshot := .Values.persistence.snapshots }}
        aws ec2 create-volume --availability-zone=${REGION}a --snapshot-id {{ $snapshot.id }} --region=${REGION} --volume-type gp2 --tag-specifications 'ResourceType=volume,Tags=[{Key=KubernetesCluster,Value=${CLUSTER_NAME}}]'
              
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: {{ include "common.fullname" $ }}-snapshot-{{ $snapshot.id }}
          labels:
        {{ include "common.labels.standard" $ | indent 4 }}
        spec:
          storageClassName: gp2
          accessModes:
          - ReadWriteOnce
          capacity:
            storage: {{ $snapshot.size }}
          persistentVolumeReclaimPolicy: Retain
          awsElasticBlockStore:
            fsType: ext4
            volumeID: aws://${REGION}/{{ $snapshot.id }}
        EOF

        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: {{ include "common.fullname" $ }}-data-{{ $index }}
          labels:
        {{ include "common.labels.standard" $ | indent 4 }}
        spec:
          accessModes:
          - ReadWriteOnce
          resources:
            requests:
              storage: {{ $snapshot.size }}
          storageClassName: gp2
          volumeName: {{ include "common.fullname" $ }}-snapshot-{{ $snapshot.id }}
        EOF
        {{- end }}
